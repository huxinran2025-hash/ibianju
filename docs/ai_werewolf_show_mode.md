# AI 狼人杀·秀场版方案

## 核心理念
- **AI 仅看文字**：后台推理上下文严格限制为自身身份与公开信息，杜绝“明牌”信息泄露。
- **观众明牌+配音演出**：前端展示所有身份并播放语音，营造强烈的戏剧冲突。
- **低成本、低延迟、好看好播**：通过轻量状态机、并行管线和队列调度，保证 1.2s 内起播体验，适配短视频与直播。

## 演出模式
### 基本规则
1. 6 位 AI 围坐 2D 圆桌（上帝视角）。
2. 观众屏幕显示全部角色身份，AI 仅知自身份与公开信息。
3. 回合顺序：夜晚行动 → 白天发言 → 投票放逐。
4. 发言时长 8–12 秒（约 150–220 字），整局控制在 10–15 分钟。
5. 弹幕仅供观众互动，不参与 AI 决策。

### 画面布局
- **主舞台**：像素/扁平风圆桌，座位 A–F，头像、名牌、身份徽章（仅观众层可见）。
- **高亮机制**：当前发言者座位微缩放+呼吸光，高亮字幕气泡滚动。
- **信息区**：左上显示阶段、回合、存活状态；右上为发言顺序；底部为弹幕区。

### 音频设计
- 每位 AI 绑定独特声线（冷静、毒舌、活泼、沉静、阴郁、稳重）。
- 发言 TTS 队列：语音播放结束后 0.3s 间隔再切换下一位。
- 音量控制：目标响度 -14 LUFS，旁白触发时自动 ducking 6dB。
- 可选：1% 音量的环境底噪，昼夜切换播放过场音效。

## 系统架构
```
[Orchestrator 回合引擎]
├─ 状态机：昼夜/发言/投票流程
├─ 公告层：观众明牌与结果播报
├─ 私密层：AI 可见上下文（身份+公开信息）
├─ 调用 AI：DeepSeek / Gemini 等通用 LLM
└─ TTS 管道：文本→语音队列→播放器

[AI 适配器]
├─ Prompt 生成：按身份裁剪信息
├─ 长度控制：≤220 字
└─ 重试/超时：3s 内无响应则调用兜底模板

[前端演出端]
├─ 2D 场景（Canvas/WebGL/Unity）
├─ 字幕渲染（逐字机）
├─ 语音播放器（顺序播放/交叉淡化）
└─ 弹幕与互动（不入 AI 上下文）
```

### 延迟预算（单次发言）
| 阶段 | 时长 | 说明 |
| --- | --- | --- |
| LLM 推理 | 400–1200ms | 中等提示长度 |
| TTS 合成 | 200–800ms | 短句批量处理 |
| 预读策略 | - | 文本到位即启动 TTS，字幕延迟 300ms 对齐 |

> 单次发言起播延迟可控 ≤1.2s，整体播放顺滑。

## 对局配置
- 角色：2 狼人、女巫、猎人、平民×2（无预言家配置）。
- 胜负条件：
  - **好人胜**：狼人全部出局。
  - **狼人胜**：狼人数量 ≥ 好人数量。
- 座位：顺时针 A–F。
- 阶段时长：
  - 夜晚行动 6–10 秒。
  - 白天发言 25–40 秒。
  - 投票 8 秒。
- 复盘仅在分出胜负后统一进行一次。

### 核心特点
- **没有预言家**：好人失去最稳定的信息源，全部判断都来自发言、逻辑与行为。
- **双强神组合**：女巫与猎人都具备强自保与反击能力，提升好人容错率。
- **信息稀缺**：首日即充满不确定性，狼人更易隐藏，好人必须凭借听发言抓狼。

## 状态机流程
1. 发牌/开场旁白 → 播放低音鼓点 BGM（-20 LUFS）。
2. **夜晚 1**：
   - 狼人密聊并选择击杀目标，可战术自刀。
   - 女巫查看当夜伤亡，可决定是否用解药或毒药（各一次，互斥，可跨夜存留）。
   - 猎人夜晚无行动，专注于白天威慑。
3. 天亮结算 → 公布夜亡名单（若女巫救则为 0 人）。
4. 白天发言（顺时针）→ 可选自由讨论 → 投票放逐。
5. 遗言与技能：
   - 猎人夜亡或被放逐可决定是否开枪带走一人。
6. 胜负判定 → 若未结束回到步骤 2，否则播报复盘。

## 策略与技巧
### 好人阵营（女巫、猎人、平民）
**女巫**
- 强烈建议首夜使用解药：在无预言家的信息黑夜里，多一轮发言与投票极其关键。
- 视局势决定是否报“银水”：公开你救过的人能提供锚点，但需警惕狼人自刀骗药。
- 毒药应在把握足够时使用：通常在听过 1–2 轮发言后再下毒，尽量做到八成把握。

**猎人**
- 前期隐藏身份保持威慑，局势紧张时可亮身份带队压票。
- 被放逐或夜杀前务必冷静判断枪口，重点观察谁主导票出你；没把握宁可不开枪。

**平民**
- 扮演“发言分析师”，抓逻辑矛盾并持续追问。
- 双向盘逻辑：分别推演嫌疑人为狼与为好人的情况，结合队友关系锁定狼坑。
- 勇敢站边与投票，避免成为弃票挂件。

### 狼人阵营
- **悍跳身份**：由于没有真预言家对跳，可大胆声称自己是女巫或猎人，甚至报队友为银水。
- **自刀骗药**：成功骗出女巫解药即可多活一轮，并让同伴伪装成高信用的“银水”。
- **击杀优先级**：优先刀发言好、逻辑强或可能是女巫/猎人的玩家；局势大优时也可冒险刀猎人。

### 典型局势
- **首夜平安**：狼人刀中目标被女巫救起，白天信息极度稀缺，狼人可混淆视听。
- **双死白天**：女巫在第二夜下毒命中，白天可能出现双死，局势瞬间明朗或更复杂。
- **猎人翻盘**：关键时刻猎人亮枪或带走狼人，可直接改写胜负。

## 记忆体系与上下文编排
### 一句话概览
单模型多会话：6 个座位 = 6 个独立会话 + 1 份公共《比赛纪要（Chronicle）》。两层记忆：

1. **公共纪要**：GM 维护全局转录与多级摘要，所有座位的公共上下文都从这里抽取。
2. **座位私有笔记**：由各座位在发言后自写的要点，下一次发言再喂回，仅本人可见。

每次发言流程：GM 依次下发 LIFE_CHECK → CONTEXT → 公共纪要摘要 → 私有笔记 → 阶段指令。死人会话因 LIFE_CHECK 接到 [SKIP] 而不再发言。发言完成后，GM 触发 WRITE_NOTES 模板，让该座位把关键点写回私有记忆。

### 公共纪要数据结构
纪要由 Orchestrator/GM 单独维护，既保存全量逐字稿，又维护多级摘要控 token。推荐结构见 `schemas/chronicle.json`：

```json
{
  "meta": { "players": 6, "seats": [1,2,3,4,5,6] },
  "rounds": [
    {
      "round": 1,
      "night": {
        "events": [
          {"t":"N1_wolves_meet","wolves":[2,5]},
          {"t":"N1_kill","by":"wolves","target":3},
          {"t":"N1_witch_heal","target":3,"used_heal":true},
          {"t":"N1_self_poison_plan","notes":"女巫暂存毒药"}
        ],
        "summary_5": ["狼相认：2&5","刀3被救","女巫暂留毒药"]
      },
      "day": {
        "order": [1,2,3,4,5,6],
        "utterances": [
          {"seat":1,"idx":1,"text":"……原文逐字转录……","one_line":"1：站2怀疑5，跟4节奏，意向投5"},
          {"seat":2,"idx":2,"text":"……","one_line":"2：自称民，回怼1，挂6"}
        ],
        "votes": [{"from":1,"to":5},{"from":2,"to":6}],
        "lynch": 5,
        "summary_10": ["票型：1->5,2->6","5被放逐","2与1强对线","女巫被质疑自保"]
      }
    }
  ],
  "global_summary": [
    "核心脉络：首夜平安；5被放逐；2多次换票；1始终跟救人视角。",
    "狼坑候选：2/6；好人锚：女巫守线。",
    "节奏提醒：关注2与6后续互跳、女巫技能剩余一次。"
  ]
}
```

> `global_summary` 推荐保持 3–6 条 bullet，既满足 schema 最小数量要求，也防止摘要过长。

GM 每轮结束更新纪要：

- `utterances[].text` 保留逐字原话，用于复盘、互喷或引用。
- `one_line` 是逐句精简摘要，用于汇总 `summary_10`。
- `summary_5`/`summary_10`/`global_summary` 构成三层摘要，喂给模型时优先发送摘要 + 最近增量转录，节省 token。
- 夜晚事件可通过 `used_heal`、`used_poison`、`poison_target` 或 `notes` 字段记录女巫操作与战术意图。

### 座位私有笔记结构
每个座位拥有独立的私有记忆，GM 在发言结束后发送 WRITE_NOTES 模板，模型输出 3–5 条短句并写入 `schemas/player_notes.json` 所示结构：

```json
{
  "players": {
    "1": {
      "role_private": {"is_wolf": false, "wolf_mates": []},
      "notes": [
        {"r":1,"d":"day","bullets":[
          "首发：定5为狼坑，跟4",
          "2回怼我并挂6，风格偏激",
          "票给5（放逐成功）"
        ]},
        {"r":1,"d":"night","bullets":["无行动"]}
      ],
      "trust": {"1":50,"2":40,"3":55,"4":70,"5":20,"6":60}
    }
  }
}
```

下次轮到座位 1 时，GM 从 `notes` 中提取最近 5–10 条要点重新注入，保证角色“记得”自己的言行与计划。

### Prompt 资产打包
全部提示词拆分在 `prompts/` 目录：

- `system_common.md`：通用 System 指令。
- `system_role_*.md`：各身份（wolf、witch、hunter、villager）的私有补充。
- `stage_*.md`：GM 在不同阶段下发的模板，覆盖 LIFE_CHECK、CONTEXT、CHRONICLE_DIGEST、YOUR_NOTES、DAY_TALK、VOTE、夜晚行动、OPENING_LINE、WRITE_NOTES、POSTGAME 等。

GM 只需按照“LIFE_CHECK → CONTEXT → CHRONICLE_DIGEST → YOUR_NOTES → 阶段指令”的顺序拼接消息即可。

### 上下文控制技巧

- **近因优先**：`recent_transcript` 仅下发最近 6–12 句原话，其余依赖摘要。
- **层级摘要**：逐句 → 每轮 → 全局三层摘要；必要时可下发关键 quotes。
- **私有笔记短句化**：WRITE_NOTES 要求每条 ≤16 字，写读成本低。

## Prompt 策略
详细提示词拆分见 `prompts/` 目录；本节给出总体策略。

- **公共 System Prompt**：强调保密、自身胜利条件、口语化表达、立场→证据→票意结构，以及保持 1–2 个核心冲突对象。
- **角色补充**：
  - 狼人：悍跳伪装、制造合理怀疑、推进错误票型、被实锤后的应对。
  - 女巫：首夜救人倾向、银水与毒药节奏、谨慎亮身份。
  - 猎人：威慑与票型引导、被推时的枪口判断。
  - 平民：站队、追问、勇于投票。
- **阶段指令**：夜晚/白天/投票/复盘环节均提供结构化模板，输出易解析。

### 夜晚指令概览
- 狼人：`stage_night_wolves.md` 强制输出【击杀】座位X，可附备选与短理由。
- 女巫：`stage_night_witch.md` 在救人/下毒/空过中三选一，并附 ≤10 字理由。
- 猎人：`stage_hunter_trigger.md` 处理夜亡/处决后的技能。

### 白天与投票
- DAY_TALK 模板要求引用摘要或原话、保持 120–180 字、末行输出【票】座位X 或【暂定】座位X。
- VOTE 模板仅允许【投票】座位X，保证 GM 易解析。

### 复盘与互喷
- POSTGAME_CONTEXT 汇总全局摘要、关键轮摘要、关键原话与私有尾记。
- POSTGAME_ROUNDUP + POSTGAME_ROAST 指导模型完成 120–180 字复盘与 2–3 句轻度互喷。

## 防拖沓策略
- 超时自动提交保守策略（如投给公认可疑最高者、女巫空过）。
- 发言长度监控：重复率 >60% 自动缩句。
- 夜晚旁白轻声沉浸。
- 投票前自动生成 3 条参考理由，帮助 AI 给出合理投票说明。
- 长时间平票触发 1v1 加时对线，各 10 秒后复投。

## TTS 管线
1. 发言文本生成后进入 TTS 队列（voiceId 绑定座位）。
2. 句内按标点切分并行合成，最终合并 PCM/OGG。
3. 播放时推送 word-timestamp，驱动字幕逐字高亮。

## 落地步骤
1. **原型阶段**：使用脚本式 Orchestrator + Web 前端，演示单局流程。
2. **AI 接入**：实现 Prompt 裁剪、长度控制、重试兜底。
3. **TTS 与字幕**：接入多声线 TTS，完成字幕同步。
4. **互动扩展**：弹幕、投票、加时对线、复盘总结等附加玩法。

## 落地资产包
- `prompts/`：完整的 System/Stage 提示词拆分，GM 可按阶段拼装。
- `schemas/chronicle.json`：公共纪要数据结构规范。
- `schemas/player_notes.json`：座位私有记忆规范。
- `docs/gm_state_machine.md`：约 100 行 GM 状态机伪代码，包含纪要增量与摘要调用位置。

> 方案确保后台推理与前台演出分层，兼顾公平性与观赏性，可直接用于短视频直播或赛事活动。
